# SQL

Полезные ресурсы:

- [SQL Tutorial, есть готовые БД, для тестирование `sql` команд](https://www.w3schools.com/sql/)
- [Примеры и описание `sql` команд](http://2sql.ru/advanced/sql-in/)
- [Тестовые БД](https://www.sql-ex.ru/db_script_download.php?Lang=0)

---

| Символы | Описание                  |
| ------- | ------------------------- |
| `*`     | Подразумевает все столбцы |
| `,`     | Перечисление              |

[Функции и операторы `PostgreSQL`](https://postgrespro.ru/docs/postgrespro/9.5/functions)

| Команда                                      | Описание                                  |
| -------------------------------------------- | ----------------------------------------- |
| `SELECT <ИзСтолбцов>`                        | Забрать данные                            |
| `FROM <ИзТаблицы>`                           | Откуда взять данные, обычно из таблицы    |
| `WHERE <Уловия>`                             | Условие выборки[WHERE](#WHERE)            |
| `LIMIT <ДоЧисла>`                            | Ограничить выборку записей                |
| `LIMIT <ДоЧисла> OFFSET <СколькоПропустить>` | Пропустить с начало, и ограничить выборку |
|                                              |                                           |

## `WHERE`

```sql
WHERE {Название_Столбца} {Операторы}
```

| Операторы                            | Описание                                                                        |
| ------------------------------------ | ------------------------------------------------------------------------------- |
| `==`                                 |                                                                                 |
| `!=`                                 |                                                                                 |
| `>`                                  |                                                                                 |
| `<`                                  |                                                                                 |
| `>=`                                 |                                                                                 |
| `<=`                                 |                                                                                 |
| `AND`                                |                                                                                 |
| `OR`                                 |                                                                                 |
| `BETWEEN <от> AND <до>`              | Промежуток                                                                      |
| `LIKE <шаблон>`                      | Устанавливает соответствие символьной строки с простым шаблоном.                |
| `IN (<значение1>,<значение2>, ...)`  | совпадает ли значение объекта со значением в списке.                            |
| `NOT`                                | Отрицание                                                                       |
| `SIMILAR TO <регуляроное выражение>` | Устанавливает соответствие символьной строки с шаблоном.(Регулярному выражению) |
|                                      |                                                                                 |

| `LIKE` | [+](https://postgrespro.ru/docs/postgrespro/9.5/functions-matching#functions-like) |
| ------ | ---------------------------------------------------------------------------------- |
| `'%'`  | Строка любой длинны                                                                |
| `'_'`  | Любой одиночный символ                                                             |

| `SIMILAR TO` | [+](https://postgrespro.ru/docs/postgrespro/9.5/functions-matching#functions-similarto-regexp) |
| ------------ | ---------------------------------------------------------------------------------------------- |
| `'│'`        | означает выбор (одного из двух вариантов).                                                     |
| `'*'`        | повторение предыдущего элемента 0 и более раз.                                                 |
| `'+'`        | повторение предыдущего элемента 1 и более раз.                                                 |
| `'?'`        | вхождение предыдущего элемента 0 или 1 раз.                                                    |
| `'{от,до}'`  | повторение предыдущего элемента `от` - `до` раз                                                |
| `'()'`       | объединяют несколько элементов в одну логическую группу.                                       |
| `[]`         | Причисление подходящих символов                                                                |
| `[^]`        | Причисление НЕ подходящих символов                                                             |

## Агрегатные функции

**Агрегатные функции** - это функции применяемые к набору входных данных и возвращающие по ним одно результирующее значение

| Функции            | Описание   |
| ------------------ | ---------- |
| `avg(выражение)`   | Среднее    |
| `count(выражение)` | Количество |
| `max(выражение)`   | Максимум   |
| `min(выражение)`   | Минимум    |
| `sum(выражение)`   | Сумма      |
|                    |            |

https://postgrespro.ru/docs/postgrespro/9.5/functions-aggregate

# Сохранить и перенести БД - `dump`

## `SQLite3`

Для того чтобы сохранить данные БД, нужно сделать `Dump`.

```bush
sqlite3 ИмяБД.sqlite .dump > ДампФайл.sql
```

> Создать `dump` определённой таблицы из БД
>
> 1. Войти в Бд из которой нужно сохранить таблицу `sqlite ИмяБД.db`
> 2. Выбрать файл в который будет записан результат `.output ДампФайл.sql`
> 3. Создать дамп определённой таблицы `.dump ИмяТаблицы`
> 4. Выйти из БД `.exit`

Для того чтобы восстановить БД из `dump`

```bush
sqlite3 ИмяНовойБд.db < ДампФайл.sql
```

---

## `PostgreSQL`

Для того чтобы сохранить данные БД, нужно сделать `Dump`.

1. Войти в `sudo -iu postgres`
2. Сделать `dump`

```bush
pg_dump -h Хост -U Пользователь -F Формат -f ПутькДамбФайл.dump ИмяБдКоторуюСохранить
```

- `Хост` = если бд расположена на вашем локальном сервере то хост равен `127.0.0.1`
- `Пользователь` = Указать каким пользователем сделать дамп
- `Формат`
    - c = архив `tar.gz`
    - t = архивировать `tar`
    - p = текстовый файл
- `ПутькДамбФайл` нужно указать общедоступную папку например `/tmp/ИмяДампа.dump`
- `ИмяБдКоторуюСохранить` указать какую БД нужно сохранить

Для того чтобы восстановить БД из `dump`

```bush
psql -d ИмяБД -U ИмяПользователя < ПутькДамбФайл.dump
```

## Переносить БД через `Django`

Создать `dump` БД.

```bush
python manage.py dumpdata Приложени.Модель > ИмяДамФайла.json
```

Загрузить `dump` в новую БД.

```bush
python manage.py loaddata --database ИмяБД  ИмяДамФайла.json
```

> При первом запуске проекта сначало выполните миграции БД.
>
> ```bash
> python manage.py migrate &&  python manage.py makemigrations
> ```

# `PostgreSQL` !!!

`PostgreSQL` Реляционная, клиент серверная СУБД(система управления базами данных).

## Установка

### Установка `PostgreSQL`

---

Скачать PostgreSQL [+](https://www.postgresql.org/download/)

| Платформа  | Команда                                                                                                                                                                                                                                                          |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Arch Linux | `sudo pacman -S postgresql pgadmin4 && sudo su - postgres -c "initdb --locale ru_RU.UTF-8 -E UTF8 -D '/var/lib/postgres/data'" && sudo chown -R postgres:postgres /var/lib/postgres/` [+](https://gist.github.com/superjojo140/2a0221d517f356965371b3969f37b29f) |
| Ubuntu     | `sudo apt install postgresql postgresql-contrib`                                                                                                                                                                                                                 |
| Windows    | https://www.postgresql.org/download/windows/                                                                                                                                                                                                                     |
| MacOS      | https://www.postgresql.org/download/macosx/                                                                                                                                                                                                                      |

Запускам сервер `PostgreSQL`

```bush
sudo systemctl start postgresql
```

В ходе установки была создана учетную запись пользователя `postgres`, которая связана с используемой по умолчанию ролью `postgres`. Переходим на пользователя `postgres` который создался автоматически при загрузке `PostgreSQL`.

```bush
sudo -iu postgres
```

### Установка `pgAdmin4`

---

Для удобной работы с `PostgreSQL` установить программу `pgAdmin` [Как установить `pgAdmin` в python](https://www.pgadmin.org/download/pgadmin-4-python/).

---

**Создать сервер**

- ![Имя пользователя](_attachments/108fc5920e0f104ed6b696a1c6465054.png)
- ![Хост](_attachments/95cef8837aa984f6cbc261fc7dd9884e.png)
    > Изначально у нас есть пользователь `postgres` на локальном сервере `127.0.0.1` поэтому для теста можно использовать его.

---

Создать таблицу
![Создать таблицу](_attachments/0935a066f45d9561b0b04d129e0a5778.png)

---

## Команды `PostgreSQL`

- Справочное руководство `PostgreSQL` [+](https://postgrespro.ru/docs/postgresql/11/reference)
- `psql` = интерактивный терминал PostgreSQL [+]https://postgrespro.ru/docs/postgresql/9.6/app-psql

---

| Полезные команды для `postgres`       |                                                                           |     |
| ------------------------------------- | ------------------------------------------------------------------------- | --- |
| `sudo netstat -plunt │ grep postgres` | Посмотреть где запущен `postgreSQL`(Вызывать вне пользователя `postgres`) |     |
| `sudo -iu postgres`                   | Войти в профиль                                                           |     |
|                                       |                                                                           |     |

---

| Команды из `postgres` |                            | Документация |
| --------------------- | -------------------------- | ------------ |
| `psql`                | Заходим в командную строку |              |
| `\q`                  | Выйти из `psql`            |              |

---

| Работа с пользователями                                       |                                                                                        |                                                               |
| ------------------------------------------------------------- | -------------------------------------------------------------------------------------- | ------------------------------------------------------------- |
| `\du`                                                         | Список всех пользователей                                                              |                                                               |
| ---                                                           | ---                                                                                    |                                                               |
| `createuser --interactive -P`                                 | Создать пользователя, `--interactive` задавать вопросы, `-P` запросить создание пароля | [+](https://postgrespro.ru/docs/postgresql/11/app-createuser) |
| `\password ИмяПользователя`                                   | Сменить пароль у пользователя                                                          |                                                               |
| ---                                                           | ---                                                                                    |                                                               |
| `CREATE USER ВашеИмя WITH PASSWORD 'ВашПароль';`              | Создать нового пользователя                                                            |                                                               |
| `ALTER USER ИмяПользователя WITH PASSWORD 'НовыйПароль';`     | Изменить пароль у пользователя                                                         |                                                               |
| ---                                                           | ---                                                                                    |                                                               |
| `ALTER USER ВашеИмя WITH SUPERUSER;`                          | Дать пользователю супер права                                                          |                                                               |
| `GRANT ALL PRIVILEGES ON DATABASE 'ИмяБД' TO ИмяПользователя` | Наделить всеми правами указанного пользователя для указанной БД                        |                                                               |
| ---                                                           | ---                                                                                    |                                                               |
| `DROP USER ВашеИмя;`                                          | Удалить пользователя                                                                   |                                                               |
| `dropuser`                                                    | Удалить пользователя                                                                   | [+](https://postgrespro.ru/docs/postgresql/11/app-dropuser)   |

---

| Работа с БД              |                                                                     |
| ------------------------ | ------------------------------------------------------------------- |
| `CREATE DATABASE ИмяБД;` | Создать БД.                                                         |
| `createdb <ИмяБД>`       | Создать БД                                                          |
| ---                      | ---                                                                 |
| `DROP DATABASE ИмяБД;`   | Удалить БД. Для удаления таблицы нужно закрыть все соединения к ней |
| `dropdb <ИмяБд>`         | Удалить БД. Для удаления таблицы нужно закрыть все соединения к ней |
| ---                      | ---                                                                 |
| `\l`                     | Показать все БД                                                     |
| `\c ИмяБД`               | Подключиться к БД                                                   |
| `\conninfo`              | Информация о БД                                                     |
| `\dt`                    | Все таблицы в БД. Аналог `SELECT * FROM pg_catalog.pg_tables;`      |
|                          |                                                                     |
|                          |                                                                     |

> Закрыть все соединения с таблицей (Это нужно для удаления таблицы)
>
> ```sql
> SELECT pg_terminate_backend(pg_stat_activity.pid)
> FROM pg_stat_activity
> WHERE pg_stat_activity.datname = '<ИмяТаблицы>'
>   AND pid <> pg_backend_pid();
> ```

---

| Работа с таблицами |     |
| ------------------ | --- |
|                    |     |
|                    |     |
|                    |     |

## Информационные схемы

Информационная схема сама по себе — это схема с именем `information_schema`. Данная схема автоматически доступна во всех базах данных. Владельцем этой схемы является начальный пользователь баз данных в кластере, и этот пользователь, естественно, имеет все права в ней, включая возможность её удалить [+](https://postgrespro.ru/docs/postgresql/9.6/information-schema)

1. Получить схему таблицы. [+](https://postgrespro.ru/docs/postgresql/9.6/infoschema-columns)

```sql
SELECT column_name, column_default, data_type
FROM INFORMATION_SCHEMA.COLUMNS
WHERE table_name = 'my_table';
```

## Типы данных в `PostgreSQL`

[Исходная таблица данных](https://postgrespro.ru/docs/postgresql/9.4/datatype)

| Целые числа | Псевдонимы | Описание                                                         |
| ----------- | ---------- | ---------------------------------------------------------------- |
| smallint    | int2       | Число -32.768 ... 32.767                                         |
| integer     | int , int4 | Число -2.147.483.648 ... 2.147.483.647                           |
| bigint      | int8       | Число -9.223.372.036.854.7775.808 ... 9.223.372.036.854.7775.807 |
| smallserial | serial2    | двухбайтное целое с автоувеличением (При вставке)                |
| serial      | serial4    | четырёхбайтное целое с автоувеличением (При вставке)             |
| bigserial   | serial8    | восьмибайтное целое с автоувеличением (При вставке)              |

| Дробные числа    | Псевдонимы |                                                       |
| ---------------- | ---------- | ----------------------------------------------------- |
| numeric          | decimal    | вещественное число заданной точности.                 |
| real             | float4     | число одинарной точности с плавающей точкой (4 байта) |
| double precision | float8     | число двойной точности с плавающей точкой (8 байт)    |

| Текст                 | Псевдонимы  | Описание                                                                         |
| --------------------- | ----------- | -------------------------------------------------------------------------------- |
| character [n]         | char [n]    | символьная строка фиксированной длины (Недостающая длинна дополняется пробелами) |
| character varying [n] | varchar [n] | символьная строка переменной длины (Недостающая длинна остаётся пустой)          |
| text                  |             | символьная строка произвольной длины                                             |

| Логический | Псевдонимы | Описание                         |
| ---------- | ---------- | -------------------------------- |
| boolean    | bool       | логическое значение (true/false) |

| Дата                            | Псевдонимы  | Описание                             |
| ------------------------------- | ----------- | ------------------------------------ |
| time [ without time zone ]      |             | время суток (без часового пояса)     |
| time                            | timetz      | время суток с учётом часового пояса  |
| timestamp [ without time zone ] |             | дата и время (без часового пояса)    |
| timestamp                       | timestamptz | дата и время с учётом часового пояса |
| date                            |             | календарная дата (год, месяц, день)  |
| interval                        |             | интервал времени(`timestamp`)        |

| Другие          | Псевдонимы | Описание                                    |
| --------------- | ---------- | ------------------------------------------- |
| bit [n]         |            | битовая строка фиксированной длины          |
| bit varying [n] | varbit     | битовая строка переменной длины             |
| box             |            | прямоугольник в плоскости                   |
| bytea           |            | двоичные данные ("массив байт")             |
| cidr            |            | сетевой адрес IPv4 или IPv6                 |
| circle          |            | круг в плоскости                            |
| inet            |            | адрес узла IPv4 или IPv6                    |
| json            |            | текстовые данные JSON                       |
| jsonb           |            | двоичные данные JSON, разобранные           |
| line            |            | прямая в плоскости                          |
| lseg            |            | отрезок в плоскости                         |
| macaddr         |            | MAC-адрес                                   |
| money           |            | денежная сумма                              |
| path            |            | геометрический путь в плоскости             |
| pg_lsn          |            | Последовательный номер в журнале PostgreSQL |
| point           |            | геометрическая точка в плоскости            |
| polygon         |            | замкнутый геометрический путь в плоскости   |
| tsquery         |            | запрос текстового поиска                    |
| tsvector        |            | документ для текстового поиска              |
| txid_snapshot   |            | снимок идентификатора транзакций            |
| uuid            |            | универсальный уникальный идентификатор      |
| xml             |            | XML-данные                                  |

## Подключение `PostgreSQL` к `Django`

1. Установить адаптер в `Django` для `PostgreSQL`.

    ```bush
    pip install psycopg2-binary
    ```

1. Войти на сервер. Для этого нужно иметь установленный `postgres` [Установка PostgreSQL](#Установка%20PostgreSQL).

    ```bush
    sudo -iu postgres
    ```

1. Создать Пользователя, либо командой из пользователя `postgres`, либо `sql` командой.

    ```sql
    CREATE USER ИмяПользователя WITH PASSWORD 'ПарольПользователя';
    ```

    ```bash
    createuser --interactive -P
    ```

1. Создать БД.

    ```sql
    CREATE DATABASE ИмяБД;
    ```

1. Наделить всеми правами нашего пользователя по изменения ранее созданной БД

    ```sql
    GRANT ALL PRIVILEGES ON DATABASE "ИмяБД" TO ИмяПользователя;
    ```

1. Добавить в настройки `Django` нашу БД. `proj/settimgs.py`

    ```python
    DATABASES = {
    		# По умолчанию `Django` используйет БД с именем `default` для всех моделей.
    		# Раз мы хотим использовать `PostgreSQL` то настроим его в `default`

    		'default': {
    				'ENGINE'  : 'django.db.backends.postgresql_psycopg2',  # Адаптер
    				'NAME'    : '<ИмяБД>',  # Имя Бд
    				'USER'    : '<ИмяПользователя>',  # Имя пользователя
    				'PASSWORD': '<ПарольПользователя>',  # Пароль пользователя
    				'HOST'    : '127.0.0.1',  # Хост, мзначально `postgreSQL использовать локальный сервер.
    				'PORT'    : 5432,  # Порт для подключения. По умолчанию это 5432
    		},

    		# Можем отсавить `SQLite` которая идет по стндарту.
    		#'sqlite' : {
    		#		'ENGINE': 'django.db.backends.sqlite3',
    		#		'NAME'  : BASE_DIR / 'db.sqlite3',
    		#}

    }
    ```

1. Для того чтобы переносить данные из одной БД в другую посмотрите главу [Через Django](#Переносить%20БД%20через%20Django)
